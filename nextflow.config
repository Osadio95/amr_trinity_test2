//
// AMR Trinity Workflow Configuration
//

params {
    // Input parameters
    help = false
    version = false
    fastq = null
    bam = null
    assemblies = null
    assemblies_sheet = null
    
    // Output parameters
    out_dir = "results"
    
    // Sample parameters
    sample = null
    sample_sheet = null
    client_fields = null
    
    // AMR specific parameters
    threads = 4
    database_path = ""
    min_coverage = 80
    min_identity = 90
    
    // Advanced options
    skip_amrfinder = false
    skip_resfinder = false
    skip_rgi = false
    
    // AWS and misc
    aws_image_prefix = null
    aws_queue = null
    disable_ping = false
    analyse_unclassified = false
    analyse_fail = false
    watch_path = false
    
    // Logging
    monochrome_logs = false
    validate_params = true
    show_hidden_params = false
    
    // EPI2ME specific
    schema_ignore_params = 'show_hidden_params,validate_params,monochrome_logs,aws_queue,aws_image_prefix,wf,store_dir'
    
    // Workflow specific
    wf {
        common_sha = "sha256:latest"
        agent = null
        epi2me_instance = null
        epi2me_user = null
        example_cmd = [
            "--assemblies_sheet 'test/mini/isolates.tsv'",
            "--threads 4"
        ]
    }
}

manifest {
    name            = 'AMR Trinity'
    author          = 'Seqafrica'
    homePage        = 'https://github.com/Osadio95/AMR_trinity_test'
    description     = 'Antimicrobial resistance detection using AMRFinderPlus, ResFinder and RGI with harmonization'
    mainScript      = 'main.nf'
    nextflowVersion = '>=20.10.0'
    version         = '1.0.11'
}

// Container configuration for processes
process {
    shell = ['/bin/bash', '-euo', 'pipefail']
    
    withLabel:'amrfinderplus' {
        container = 'docker.io/ncbi/amr:4.0.23-2025-07-16.1'
        cpus = { check_max( params.threads ?: 4, 8 ) }
        memory = { 8.GB * task.attempt }
    }
    
    withLabel:'resfinder' {
        container = 'docker.io/genomicepidemiology/resfinder:4.7.2'
        containerOptions = '--entrypoint ""'
        cpus = { check_max( params.threads ?: 4, 8 ) }
        memory = { 8.GB * task.attempt }
    }
    
    withLabel:'rgi' {
        container = 'quay.io/biocontainers/rgi:6.0.5--pyh05cac1d_0'
        cpus = { check_max( params.threads ?: 4, 8 ) }
        memory = { 8.GB * task.attempt }
    }
    
    withLabel:'hamronize' {
        container = 'ghcr.io/zwets/hamronization:1.1.10'
        containerOptions = '--entrypoint ""'
        cpus = 1
        memory = { 4.GB * task.attempt }
    }
    
    withLabel:'summarise' {
        container = 'ghcr.io/zwets/hamronization:1.1.10'
        containerOptions = '--entrypoint ""'
        cpus = 1
        memory = { 4.GB * task.attempt }
    }
}

// Helper function
def check_max( val, max ) {
    return val <= max ? val : max
}

// Profiles
profiles {
    standard {
        docker {
            enabled = true
            runOptions = "--user \$(id -u):\$(id -g) --group-add 100"
        }
    }

    singularity {
        singularity {
            enabled = true
            autoMounts = true
        }
    }
    
    awsbatch {
        process {
            executor = 'awsbatch'
            queue = "${params.aws_queue}"
            memory = '16G'
            withLabel:'amrfinderplus' {
                container = "${params.aws_image_prefix}-amrfinderplus:latest"
            }
            withLabel:'resfinder' {
                container = "${params.aws_image_prefix}-resfinder:latest"
            }
            withLabel:'rgi' {
                container = "${params.aws_image_prefix}-rgi:latest"
            }
        }
    }
    
    local {
        process.executor = 'local'
    }
}

// Reporting
timeline {
    enabled = true
    file = "${params.out_dir}/execution/timeline.html"
}

report {
    enabled = true
    file = "${params.out_dir}/execution/report.html"
}

trace {
    enabled = true
    file = "${params.out_dir}/execution/trace.txt"
}

dag {
    enabled = true
    file = "${params.out_dir}/execution/dag.svg"
}

// Environment
env {
    PYTHONNOUSERSITE = 1
    JAVA_TOOL_OPTIONS = "-Xlog:disable -Xlog:all=warning:stderr"
    OMP_NUM_THREADS = 1
    MKL_NUM_THREADS = 1
}
